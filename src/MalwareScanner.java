import java.io.*;
import java.util.ArrayList;
import java.util.Map;
import java.util.Scanner;

/**
 * This class accomplishes Mission Firewall
 */
public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    /**
     * TODO: Open and read the input file while searching for threats
     * TODO: Write results to both; a new file name "scanLog.txt" and to the console
     *
     * @param filename the input file
     * @throws IOException the io exception
     */
    public void scanFile(String filename) throws IOException {
        // TODO: YOUR CODE HERE
        File file = new File(filename);
        File outputFile = new File("scanLog.txt");
        if(outputFile.delete()) {
            outputFile.createNewFile();
        }
        ArrayList<String> myArrayList = new ArrayList<>();
        try {
            Scanner reader = new Scanner(file);
            while (reader.hasNextLine()){
                String line = reader.nextLine();
                myArrayList.add(line);
            }
            reader.close();
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        int threatCounter = 0;
        System.out.println("Started scanning...");
        System.out.println("--------------------------------------------------------------------------------");
        for (int i = 0; i < myArrayList.size() ; i++){
            String result = turbo64(myArrayList.get(i));
            for (Map.Entry m : malwareDB.entrySet()) {
                if (result.equals(m.getKey())){
                    writeFile(outputFile, result + "@" + (i+1));
                    threatCounter ++;
                    System.out.println("Detected malware!");
                    System.out.println(m.getValue().toString());
                    System.out.println("--------------------------------------------------------------------------------");
                }
            }
        }
        System.out.println("Scan complete! " + threatCounter + " threats are found and eliminated. Generating log file...");
    }

    public static String turbo64(String in) {
        // Implement turbo64 algorithm given by the assignment instructions
        // TODO: YOUR CODE HERE
        long mod_turbo = 4294967291L;
        long a = 0;
        long b = 1;
        for (char c: in.toCharArray()) {
            a = (a + (int) c) % mod_turbo;
            b = (a + b) % mod_turbo;
        }
        return Long.toHexString((b << 32) | a);
    }
    public static void writeFile(File file, String line){
        try {
            BufferedWriter writer = new BufferedWriter(new FileWriter(file.getAbsolutePath(),true));
            if (file.length() != 0) {
                writer.newLine();
            }
            writer.write(line);
            writer.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
